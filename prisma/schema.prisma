generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String            @id @default(cuid())
  email             String            @unique
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  clerkUserId       String            @unique
  fullName          String
  role              UserRole          @default(USER)
  createdActivities Activity[]
  subscriptions     Subscription?
  consentRecords    ConsentRecord[]
  downloadHistory   DownloadHistory[]
}

model Activity {
  id              String             @id @default(cuid())
  name            String
  description     String
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  ageRange        AgeRange
  createdById     String
  difficulty      ActivityDifficulty
  isPublic        Boolean            @default(true)
  type            ActivityType
  phoneme         String             @default("")
  createdBy       User               @relation(fields: [createdById], references: [id])
  files           ActivityFile[]
  downloadHistory DownloadHistory[]
  categories      ActivityCategory[] @relation("ActivityToActivityCategory")
}

model ActivityFile {
  id           String   @id @default(cuid())
  activityId   String
  name         String
  s3Key        String
  s3Url        String
  fileType     String
  sizeInBytes  Int
  uploadedById String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  activity     Activity @relation(fields: [activityId], references: [id])
}

model ActivityCategory {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  activities  Activity[] @relation("ActivityToActivityCategory")
}

model Subscription {
  id                 String    @id @default(cuid())
  userId             String    @unique
  tier               TierType  @default(FREE)
  status             SubStatus @default(INACTIVE)
  currentPeriodStart DateTime  @default(now())
  currentPeriodEnd   DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  paymentId          String?
  user               User      @relation(fields: [userId], references: [id])
}

model DownloadHistory {
  id           String   @id @default(cuid())
  userId       String
  activityId   String
  fileName     String
  fileSize     Int?
  downloadedAt DateTime @default(now())
  ipAddress    String?
  userAgent    String?
  activity     Activity @relation(fields: [activityId], references: [id])
  user         User     @relation(fields: [userId], references: [id])

  @@index([userId, downloadedAt])
  @@index([activityId])
  @@map("download_history")
}

model DownloadLimit {
  id        String   @id @default(cuid())
  userId    String   @unique
  downloads Int      @default(0)
  resetDate DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("download_limits")
}

model ConsentRecord {
  id              String            @id @default(cuid())
  userId          String
  consentType     ConsentType
  purpose         String
  legalBasis      LegalBasis
  granted         Boolean
  grantedAt       DateTime?
  withdrawnAt     DateTime?
  expiresAt       DateTime?
  ipAddress       String?
  userAgent       String?
  consentMethod   ConsentMethod     @default(EXPLICIT)
  dataCategories  String[]
  thirdParties    String[]
  retentionPeriod Int?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  auditLogs       ConsentAuditLog[]
  user            User              @relation(fields: [userId], references: [id])

  @@index([grantedAt])
  @@index([expiresAt])
  @@index([userId, consentType])
  @@map("consent_records")
}

model ConsentAuditLog {
  id              String        @id @default(cuid())
  consentRecordId String
  action          ConsentAction
  previousValue   Json?
  newValue        Json?
  reason          String?
  performedBy     String?
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime      @default(now())
  consentRecord   ConsentRecord @relation(fields: [consentRecordId], references: [id])

  @@index([consentRecordId])
  @@index([createdAt])
  @@map("consent_audit_logs")
}

model DataRetentionPolicy {
  id              String     @id @default(cuid())
  dataCategory    String     @unique
  purpose         String
  retentionPeriod Int
  legalBasis      LegalBasis
  isActive        Boolean    @default(true)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@map("data_retention_policies")
}

model DataRetentionLog {
  id                String          @id @default(cuid())
  userId            String
  dataCategory      String
  action            RetentionAction
  recordsAffected   Int
  retentionPolicyId String?
  processedAt       DateTime        @default(now())

  @@index([userId, dataCategory])
  @@index([processedAt])
  @@map("data_retention_logs")
}

model BlogPost {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Analytics
  viewCount   Int      @default(0)
  likeCount   Int      @default(0)
  
  // Relations
  views       BlogView[]
  likes       BlogLike[]
  
  @@map("blog_posts")
}

model BlogView {
  id        String    @id @default(cuid())
  postId    String
  post      BlogPost  @relation(fields: [postId], references: [id], onDelete: Cascade)
  ipAddress String?
  userAgent String?
  referer   String?
  viewedAt  DateTime  @default(now())
  
  @@index([postId])
  @@index([viewedAt])
  @@map("blog_views")
}

model BlogLike {
  id        String    @id @default(cuid())
  postId    String
  post      BlogPost  @relation(fields: [postId], references: [id], onDelete: Cascade)
  ipAddress String?
  userAgent String?
  likedAt   DateTime  @default(now())
  
  @@unique([postId, ipAddress])
  @@index([postId])
  @@index([likedAt])
  @@map("blog_likes")
}

enum UserRole {
  ADMIN
  USER
}

enum ActivityType {
  ANIMALS
  COLOURS
  MEANS_OF_TRANSPORT
  CLOTHING
  LANGUAGE
  PROFESSIONS
  GEOMETRIC_SHAPES
  NUMBERS_AND_LETTERS
  MOTOR_SKILLS
  HUMAN_BODY
  OTHER
  SPEECH
  COGNITIVE
  MOTOR
  SOCIAL
}

enum ActivityDifficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum AgeRange {
  TODDLER
  PRESCHOOL
  CHILD
  TEENAGER
  ADULT
}

enum TierType {
  FREE
  PRO
}

enum SubStatus {
  ACTIVE
  INACTIVE
  PAST_DUE
}

enum ConsentType {
  DATA_PROCESSING
  MARKETING_COMMUNICATIONS
  ANALYTICS_TRACKING
  THIRD_PARTY_SHARING
  COOKIES_ESSENTIAL
  COOKIES_ANALYTICS
  COOKIES_FUNCTIONAL
  COOKIES_MARKETING
  DATA_EXPORT
  DATA_DELETION
  PROFILING
  AUTOMATED_DECISION_MAKING
}

enum LegalBasis {
  CONSENT
  CONTRACT
  LEGAL_OBLIGATION
  VITAL_INTERESTS
  PUBLIC_TASK
  LEGITIMATE_INTERESTS
}

enum ConsentMethod {
  EXPLICIT
  IMPLICIT
  OPT_IN
  OPT_OUT
  GRANULAR
  BUNDLED
}

enum ConsentAction {
  GRANTED
  WITHDRAWN
  UPDATED
  EXPIRED
  RENEWED
  REVOKED
}

enum RetentionAction {
  RETAIN
  DELETE
  ANONYMIZE
  ARCHIVE
  NOTIFY_EXPIRY
}
